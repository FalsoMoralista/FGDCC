INFO:faiss.loader:Loading faiss with AVX2 support.
INFO:faiss.loader:Successfully loaded faiss with AVX2 support.
INFO:faiss.loader:Loading faiss with AVX2 support.
INFO:faiss.loader:Successfully loaded faiss with AVX2 support.
INFO:root:called-params configs/in1k_vith14_ep300_FGDCC.yaml
INFO:root:loaded params...
{   'data': {   'batch_size': 96,
                'color_jitter_strength': 0.0,
                'crop_scale': [0.3, 1.0],
                'crop_size': 224,
                'cutmix': 0.0,
                'drop_path': 0.25,
                'image_folder': '/home/rtcalumby/adam/luciano/plantnet_300K/',
                'mixup': 0.0,
                'nb_classes': 1081,
                'num_workers': 8,
                'pin_mem': True,
                'reprob': 0.25,
                'resume_epoch': 0,
                'root_path': '/home/rtcalumby/adam/luciano/',
                'use_color_distortion': False,
                'use_gaussian_blur': False,
                'use_horizontal_flip': False},
    'logging': {   'folder': '/home/rtcalumby/adam/luciano/LifeCLEFPlant2022/logs/PlantNet300k_exp21',
                   'write_tag': 'jepa'},
    'mask': {   'allow_overlap': False,
                'aspect_ratio': [0.75, 1.5],
                'enc_mask_scale': [0.85, 1.0],
                'min_keep': 10,
                'num_enc_masks': 1,
                'num_pred_masks': 4,
                'patch_size': 14,
                'pred_mask_scale': [0.15, 0.2]},
    'meta': {   'copy_data': False,
                'load_checkpoint': True,
                'model_name': 'vit_huge',
                'pred_depth': 12,
                'pred_emb_dim': 384,
                'read_checkpoint': None,
                'use_bfloat16': True},
    'optimization': {   'ema': [0.9, 0.999],
                        'epochs': 50,
                        'final_lr': 3e-06,
                        'final_weight_decay': 0.4,
                        'ipe_scale': 1.0,
                        'label_smoothing': 0.1,
                        'lr': 0.0006,
                        'start_lr': 0.00015,
                        'warmup': 5,
                        'weight_decay': 0.05}}
INFO:root:Running... (rank: 0/1)
INFO:root:Initialized (rank/world-size) 0/1
INFO:root:MaskedAutoEncoder(
  (encoder): Sequential(
    (0): Linear(in_features=1024, out_features=768, bias=True)
    (1): GELU(approximate='none')
    (2): Linear(in_features=768, out_features=512, bias=True)
    (3): GELU(approximate='none')
    (4): Linear(in_features=512, out_features=384, bias=True)
    (5): GELU(approximate='none')
  )
  (decoder): Sequential(
    (0): Linear(in_features=384, out_features=512, bias=True)
    (1): GELU(approximate='none')
    (2): Linear(in_features=512, out_features=768, bias=True)
    (3): GELU(approximate='none')
    (4): Linear(in_features=768, out_features=1024, bias=True)
  )
)
INFO:root:making imagenet data transforms
INFO:root:making imagenet data transforms
INFO:root:Finetuning dataset created
Training dataset, length: 245952
INFO:root:Finetuning dataset created
Val dataset, length: 31200
INFO:root:Using AdamW
['encoder', 'predictor', 'opt', 'scaler', 'target_encoder', 'epoch', 'loss', 'batch_size', 'world_size', 'lr']
INFO:root:loaded pretrained encoder from epoch 66 with msg: <All keys matched successfully>
INFO:root:Using AdamW
INFO:root:VisionTransformer(
  (patch_embed): PatchEmbed(
    (proj): Conv2d(3, 1280, kernel_size=(14, 14), stride=(14, 14))
  )
  (blocks): ModuleList(
    (0-31): 32 x Block(
      (norm1): LayerNorm((1280,), eps=1e-06, elementwise_affine=True)
      (attn): Attention(
        (qkv): Linear(in_features=1280, out_features=3840, bias=True)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (proj): Linear(in_features=1280, out_features=1280, bias=True)
        (proj_drop): Dropout(p=0.0, inplace=False)
      )
      (drop_path): Identity()
      (norm2): LayerNorm((1280,), eps=1e-06, elementwise_affine=True)
      (mlp): MLP(
        (fc1): Linear(in_features=1280, out_features=5120, bias=True)
        (act): GELU(approximate='none')
        (fc2): Linear(in_features=5120, out_features=1280, bias=True)
        (drop): Dropout(p=0.0, inplace=False)
      )
    )
  )
  (norm): LayerNorm((1280,), eps=1e-06, elementwise_affine=True)
)
INFO:root:Building cache...
INFO:root:Done.
INFO:root:Initializing centroids...
INFO:root:Done.
INFO:root:M - Step...
/home/rtcalumby/miniconda3/envs/py382/lib/python3.12/site-packages/faiss/contrib/torch_utils.py:51: UserWarning: TypedStorage is deprecated. It will be removed in the future and UntypedStorage will be the only storage class. This should only matter to you if you are using storages directly.  To access UntypedStorage directly, use tensor.untyped_storage() instead of tensor.storage()
  x.storage().data_ptr() + x.storage_offset() * 4)
WARNING clustering 10 points to 2 centroids: please provide at least 78 training points
WARNING clustering 10 points to 3 centroids: please provide at least 117 training points
WARNING clustering 10 points to 4 centroids: please provide at least 156 training points
WARNING clustering 10 points to 5 centroids: please provide at least 195 training points
No. Samples: 835
FAISS K-MEANS (on CPU execution): 2.0420022010803223 seconds
OUR K-MEANS (on GPU execution): 4.760965585708618 seconds
GPU runtime gain: 2.331518341748029
Qualitative Results:
Difference (centroid 0):
tensor(-4.4626e-09)
-------------------------------------------------
Difference (centroid 1):
tensor(1.1952e-08)
No. Samples: 10
FAISS K-MEANS (on CPU execution): 137.17868995666504 seconds
OUR K-MEANS (on GPU execution): 0.0067441463470458984 seconds
GPU runtime gain: 4.916322170139097e-05
Qualitative Results:
Difference (centroid 0):
tensor(0.)
-------------------------------------------------
Difference (centroid 1):
tensor(2.7940e-09)
No. Samples: 1762
FAISS K-MEANS (on CPU execution): 2.6133744716644287 seconds
OUR K-MEANS (on GPU execution): 6.383365154266357 seconds
GPU runtime gain: 2.44257576687847
Qualitative Results:
Difference (centroid 0):
tensor(-1.8626e-08)
-------------------------------------------------
Difference (centroid 1):
tensor(-1.8626e-08)
No. Samples: 2330
FAISS K-MEANS (on CPU execution): 2.4918081760406494 seconds
OUR K-MEANS (on GPU execution): 15.239269256591797 seconds
GPU runtime gain: 6.1157473529146955
Qualitative Results:
Difference (centroid 0):
tensor(-5.2154e-08)
-------------------------------------------------
Difference (centroid 1):
tensor(-1.2418e-09)
No. Samples: 2739
FAISS K-MEANS (on CPU execution): 2.7430031299591064 seconds
OUR K-MEANS (on GPU execution): 11.188447713851929 seconds
GPU runtime gain: 4.07890446483695
Qualitative Results:
Difference (centroid 0):
tensor(-1.3659e-08)
-------------------------------------------------
Difference (centroid 1):
tensor(-4.6566e-08)
